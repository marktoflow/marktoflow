# Batch Pull Request Processing

This workflow demonstrates using `parallel.map` to process multiple pull requests concurrently, significantly speeding up batch operations.

```yaml
name: Batch PR Review
description: Review multiple pull requests in parallel using AI agents

inputs:
  repository:
    type: string
    description: GitHub repository (owner/repo)
  pr_state:
    type: string
    default: open
    description: PR state filter (open, closed, all)

tools:
  github:
    sdk: "@octokit/rest"
    auth:
      token: {{ env.GITHUB_TOKEN }}

steps:
  # Step 1: Fetch all open PRs
  - id: fetch_prs
    action: github.pulls.list
    inputs:
      owner: {{ inputs.repository =~ /^([^\/]+)\//  }}
      repo: {{ inputs.repository =~ /\/(.+)$/  }}
      state: {{ inputs.pr_state }}
      per_page: 50
    outputs:
      pull_requests: {{ output.data }}

  # Step 2: Process PRs in parallel (up to 5 concurrent agents)
  - id: review_prs
    action: parallel.map
    inputs:
      items: {{ pull_requests }}
      concurrency: 5  # Process 5 PRs at a time
      timeout: 90s    # 90 seconds per PR
      onError: continue  # Continue even if some PRs fail
      
      agent:
        provider: claude
        model: haiku  # Fast model for batch processing
        prompt: |
          Review this pull request and provide analysis:
          
          **PR #{{ item.number }}:** {{ item.title }}
          **Author:** {{ item.user.login }}
          **Created:** {{ item.created_at }}
          **Branch:** {{ item.head.ref }} â†’ {{ item.base.ref }}
          **Description:**
          {{ item.body || 'No description provided' }}
          
          **Files changed:** {{ item.changed_files }}
          **Additions:** +{{ item.additions }}
          **Deletions:** -{{ item.deletions }}
          
          Analyze and provide:
          1. Summary of changes (1-2 sentences)
          2. Potential issues or risks (list)
          3. Recommendation: APPROVE, REQUEST_CHANGES, or COMMENT
          4. Priority: HIGH, MEDIUM, LOW
          5. Estimated review time: <minutes>
          
          Respond in JSON format:
          {
            "summary": "...",
            "issues": ["..."],
            "recommendation": "APPROVE|REQUEST_CHANGES|COMMENT",
            "priority": "HIGH|MEDIUM|LOW",
            "estimated_review_minutes": <number>
          }
    
    outputs:
      pr_reviews: {{ results }}

  # Step 3: Categorize PRs by recommendation
  - id: categorize_prs
    action: core.transform
    inputs:
      input: {{ pull_requests }}
      operation: group_by
      key: |
        {% set review_index = loop.index0 %}
        {{ pr_reviews[review_index].recommendation }}
    outputs:
      categorized: {{ output }}

  # Step 4: Filter high-priority PRs
  - id: high_priority_prs
    action: core.transform
    inputs:
      input: {{ pull_requests }}
      operation: filter
      condition: |
        {% set review_index = loop.index0 %}
        {{ pr_reviews[review_index].priority == "HIGH" }}
    outputs:
      urgent_prs: {{ output }}

  # Step 5: Generate summary report
  - id: generate_summary
    action: claude.chat.completions
    inputs:
      model: sonnet
      messages:
        - role: user
          content: |
            Create a PR review dashboard summary:
            
            Total PRs reviewed: {{ pull_requests | length }}
            High priority PRs: {{ urgent_prs | length }}
            
            Reviews by recommendation:
            - Approve: {{ categorized.APPROVE | default([]) | length }}
            - Request Changes: {{ categorized.REQUEST_CHANGES | default([]) | length }}
            - Comment: {{ categorized.COMMENT | default([]) | length }}
            
            High Priority PRs:
            {{ urgent_prs | json }}
            
            All Reviews:
            {{ pr_reviews | json }}
            
            Generate a markdown dashboard with:
            1. Overall statistics
            2. High-priority PRs table (number, title, author, recommendation)
            3. PRs needing attention (REQUEST_CHANGES)
            4. PRs ready to merge (APPROVE)
            5. Estimated total review time
    outputs:
      dashboard: {{ output.choices[0].message.content }}

  # Step 6: Post summary as GitHub issue (optional)
  - id: create_summary_issue
    action: github.issues.create
    conditions:
      - {{ urgent_prs | length > 0 }}  # Only create if urgent PRs exist
    inputs:
      owner: {{ inputs.repository =~ /^([^\/]+)\//  }}
      repo: {{ inputs.repository =~ /\/(.+)$/  }}
      title: "ðŸ¤– AI PR Review Dashboard - {{ now() | date('YYYY-MM-DD') }}"
      body: |
        {{ dashboard }}
        
        ---
        *Generated by marktoflow parallel.map workflow*
        *Processed {{ pull_requests | length }} PRs in parallel*
      labels:
        - ai-review
        - automation
    outputs:
      issue_url: {{ output.data.html_url }}

outputs:
  total_prs: {{ pull_requests | length }}
  high_priority_count: {{ urgent_prs | length }}
  dashboard_url: {{ issue_url }}
  reviews: {{ pr_reviews }}
  processing_stats:
    total_items: {{ pull_requests | length }}
    successful: {{ pr_reviews | selectattr('success') | list | length }}
    failed: {{ pr_reviews | rejectattr('success') | list | length }}
```

## Usage

```bash
# Review all open PRs in a repository
marktoflow run examples/parallel-agents/batch-pr-processing.md \
  --input repository=facebook/react

# Review closed PRs from last week
marktoflow run examples/parallel-agents/batch-pr-processing.md \
  --input repository=microsoft/vscode \
  --input pr_state=closed

# Use faster/cheaper model for large batches
marktoflow run examples/parallel-agents/batch-pr-processing.md \
  --input repository=vercel/next.js \
  --config agents.claude.model=haiku \
  --concurrency 10
```

## Performance Comparison

### Sequential Processing
- 50 PRs Ã— 30 seconds each = **25 minutes**
- Cost: $0.50 (assuming $0.01/PR)

### Parallel Processing (concurrency=5)
- 50 PRs Ã· 5 concurrent Ã— 30 seconds = **5 minutes**
- Cost: $0.50 (same cost, 5x faster)

### Parallel Processing (concurrency=10)
- 50 PRs Ã· 10 concurrent Ã— 30 seconds = **2.5 minutes**
- Cost: $0.50 (same cost, 10x faster)

## Key Features

1. **Concurrency Control**: Process 5 PRs at a time (configurable)
2. **Error Handling**: Continue processing even if some PRs fail
3. **Batch Processing**: Efficiently handle large numbers of PRs
4. **Smart Categorization**: Automatically group by recommendation
5. **Priority Detection**: Identify urgent PRs needing immediate attention
6. **Cost Tracking**: Monitor per-PR and total costs
7. **Auto-reporting**: Create GitHub issues for dashboards

## Advanced: Custom Filters

Process only specific PRs:

```yaml
# Add this step before parallel.map
- id: filter_prs
  action: core.transform
  inputs:
    input: {{ pull_requests }}
    operation: filter
    condition: |
      {{ item.user.login != 'dependabot[bot]' && item.changed_files < 20 }}
  outputs:
    filtered_prs: {{ output }}
```

## Integration with CI/CD

Run this workflow on a schedule to maintain PR health:

```yaml
# In your workflow file
triggers:
  - type: schedule
    cron: "0 9 * * 1-5"  # Weekdays at 9 AM
```
